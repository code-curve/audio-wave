<!DOCTYPE html>

<html>
<head>
  <title>collection.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="admin.html">
                admin.js
              </a>
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="AudioController.html">
                AudioController.js
              </a>
            
              
              <a class="source" href="ComposeController.html">
                ComposeController.js
              </a>
            
              
              <a class="source" href="ConsoleController.html">
                ConsoleController.js
              </a>
            
              
              <a class="source" href="LoginController.html">
                LoginController.js
              </a>
            
              
              <a class="source" href="SessionsController.html">
                SessionsController.js
              </a>
            
              
              <a class="source" href="UsersController.html">
                UsersController.js
              </a>
            
              
              <a class="source" href="afterTyping.html">
                afterTyping.js
              </a>
            
              
              <a class="source" href="collection.html">
                collection.js
              </a>
            
              
              <a class="source" href="console.html">
                console.js
              </a>
            
              
              <a class="source" href="editor.html">
                editor.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="adminSocket.html">
                adminSocket.js
              </a>
            
              
              <a class="source" href="collection.html">
                collection.js
              </a>
            
              
              <a class="source" href="controls.html">
                controls.js
              </a>
            
              
              <a class="source" href="socket.html">
                socket.js
              </a>
            
              
              <a class="source" href="storage.html">
                storage.js
              </a>
            
              
              <a class="source" href="uiState.html">
                uiState.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>collection.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="collection-factory">collection Factory</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The collection factory is responsible for maintaing
the state and a modification interface for collections
defined at the server side. See <code>/routes/collection/</code>
for more details.</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>After the returned function is called with a name
parameter, the adminSocket waits for the serverâ€™s
ready event, and then proceeds to listen to the events
(<strong>create</strong>, <strong>get</strong>, <strong>update</strong>, <strong>remove</strong>) 
for that name and creates a set of methods to manipulate 
the data over the socket connection.</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Finally, a dynamic array containing the models
from the collection is returned, with create, update
and remove methods tacked on to it. This can be used
bound straight to the DOM from controllers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(adminSocket)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Store all available collections in here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> collections = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Find and return a model from a collection
based on the <em>id property of the query 
object. </em>(Query object normally comes from
the database)_</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span><span class="hljs-params">(collection, query)</span> {</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; collection[i].length; i++) {
      <span class="hljs-keyword">if</span>(collection[i]._id === query._id) {
        <span class="hljs-keyword">return</span> collection[i];
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Helper method to provide clean looking
names for socket events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">events</span><span class="hljs-params">(name)</span> {</span>
    <span class="hljs-keyword">return</span> {
      get: name + <span class="hljs-string">'/get'</span>,
      create: name + <span class="hljs-string">'/create'</span>,
      remove: name + <span class="hljs-string">'/remove'</span>,
      update: name + <span class="hljs-string">'/update'</span>
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Creates interface for collection with this name
and returns dynamic collection array along
with collection manipulation methods. See
module doc comment for more details. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">model</span><span class="hljs-params">(name)</span> {</span>
    <span class="hljs-keyword">var</span> collection, socket, event;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>if we have already loaded this collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(collections[name]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>return it straight away</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      console.log(<span class="hljs-string">'load'</span>, name);
      <span class="hljs-keyword">return</span> collections[name];
    }

    console.log(<span class="hljs-string">'create'</span>, name, <span class="hljs-string">'collection factory'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>aliasing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket = adminSocket;
    collection = collections[name] = [];
    event = events(name);

    <span class="hljs-keyword">if</span>(socket.ready) {
      socket.emit(event.get);
    } <span class="hljs-keyword">else</span> {
      socket.on(<span class="hljs-string">'ready'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        socket.emit(event.get);
      });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="socket-events">Socket Events</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    socket.on(event.get, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models)</span> {</span>
      console.log(<span class="hljs-string">'GET collection data'</span>);
      collection.length = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>I believe thereâ€™s some explaining to do here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collection.push.apply(collection, models.data);
    });

    socket.on(event.create, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
      collection.push(model);
    });

    socket.on(event.remove, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
      <span class="hljs-keyword">delete</span> find(collection, model);
    });

    socket.on(event.update, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, updated)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Create safeguard with model for find -&gt; null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      (find(collection, model) || model) = updated;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="exposed-methods">Exposed methods</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>  
    collection.create = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
      socket.emit(event.create, model);
    };
    
    collection.remove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span> {</span>
      socket.emit(event.remove, model);
    };

    collection.update = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, updated)</span> {</span>
      socket.emit(event.update, model, updated);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Reveal the name of this collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    collection.name = name;
    
    <span class="hljs-keyword">return</span> collection;
  }

  <span class="hljs-keyword">return</span> model;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
